<!-- Spacer for slim overlay mode -->
<div
  *ngIf="currentMode === 'overlay' && collapsedModeForCurrentBreakpoint === 'slim'"
  class="w-16 h-full flex-shrink-0"
></div>

<aside
  *ngIf="currentMode !== 'hidden'"
  [class.w-16]="currentMode === 'slim'"
  [class.w-72]="currentMode === 'expanded' || currentMode === 'overlay'"
  [class.fixed]="currentMode === 'overlay'"
  [class.top-0]="currentMode === 'overlay'"
  [class.left-0]="currentMode === 'overlay'"
  [class.h-screen]="currentMode === 'overlay'"
  [class.h-full]="currentMode !== 'overlay'"
  [class.z-60]="currentMode === 'overlay'"
  class="flex shrink-0 border-r border-gray-200"
  [ngClass]="{
    'bg-white': currentMode === 'overlay',
    'bg-white/80 backdrop-blur-md': currentMode !== 'overlay',
  }"
>
  <div class="flex h-full w-full flex-col">
    <div
      *ngIf="currentMode === 'overlay'"
      class="h-16 w-full border-b border-gray-200 bg-white flex items-center px-4"
    >
      <div class="flex items-center gap-3">
        <div class="h-8 w-8 rounded-md bg-indigo-400"></div>
        <div class="font-semibold tracking-tight">SimpleCRM</div>
      </div>
    </div>

    <nav class="flex-1 overflow-y-auto py-4">
      <ul class="px-3 space-y-1">
        <li *ngFor="let module of sidebarItems; let si = index">
          <div *ngIf="si > 0 && currentMode === 'slim'" class="h-px bg-gray-200 my-2 w-full"></div>

          <div
            *ngIf="currentMode !== 'slim'"
            class="px-3 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wide"
          >
            {{ module.label }}
          </div>

          <ul class="pl-0">
            <li *ngFor="let item of module.items; let i = index">
              <ng-container *ngIf="$any(item).items && $any(item).items.length; else singleLink">
                <div *ngIf="currentMode === 'slim'; else expandedGroup">
                  <app-tooltip [text]="item.label" position="right">
                    <button
                      type="button"
                      class="flex items-center rounded-md text-gray-700 hover:bg-gray-200 hover:text-gray-900 px-3 py-2 justify-center cursor-pointer"
                      (click)="toggleSection(item.id)"
                      [attr.aria-expanded]="isSectionOpen(item.id)"
                    >
                      <app-icon [name]="item.icon" [iconClass]="'size-6'"></app-icon>
                    </button>
                  </app-tooltip>
                </div>

                <ng-template #expandedGroup>
                  <div>
                    <button
                      type="button"
                      class="w-full flex items-center justify-between rounded-md text-gray-700 hover:bg-gray-200 hover:text-gray-900 px-3 py-2 cursor-pointer"
                      (click)="toggleSection(item.id)"
                    >
                      <div class="flex items-center gap-3">
                        <app-icon [name]="item.icon" [iconClass]="'size-6'"></app-icon>
                        <span>{{ item.label }}</span>
                      </div>
                      <app-icon
                        [name]="isSectionOpen(item.id) ? 'chevron-up' : 'chevron-down'"
                        [iconClass]="'size-5'"
                      ></app-icon>
                    </button>

                    <ul *ngIf="isSectionOpen(item.id)" class="mt-1 space-y-1 pl-8">
                      <li *ngFor="let sub of $any(item).items">
                        <a
                          [routerLink]="sub.route"
                          routerLinkActive="bg-gray-200 text-gray-900"
                          [routerLinkActiveOptions]="{ exact: true }"
                          class="flex items-center rounded-md text-gray-700 hover:bg-gray-200 hover:text-gray-900 px-3 py-2 cursor-pointer"
                          (click)="onNavItemClick()"
                        >
                          <app-icon [name]="sub.icon" [iconClass]="'size-5'"></app-icon>
                          <span class="ml-3">{{ sub.label }}</span>
                        </a>
                      </li>
                    </ul>
                  </div>
                </ng-template>
              </ng-container>

              <ng-template #singleLink>
                <ng-container
                  *ngIf="currentMode === 'slim'; then slimLink; else expandedLink"
                ></ng-container>

                <ng-template #slimLink>
                  <app-tooltip [text]="item.label" position="right">
                    <a
                      [routerLink]="item.route"
                      routerLinkActive="bg-gray-200 text-gray-900"
                      [routerLinkActiveOptions]="{ exact: true }"
                      class="flex items-center rounded-md text-gray-700 hover:bg-gray-200 hover:text-gray-900 px-3 py-2 justify-center cursor-pointer"
                      (click)="onNavItemClick()"
                    >
                      <app-icon [name]="item.icon" [iconClass]="'size-6'"></app-icon>
                      <span class="sr-only">{{ item.label }}</span>
                    </a>
                  </app-tooltip>
                </ng-template>

                <ng-template #expandedLink>
                  <a
                    [routerLink]="item.route"
                    routerLinkActive="bg-gray-200 text-gray-900"
                    [routerLinkActiveOptions]="{ exact: true }"
                    class="flex items-center rounded-md text-gray-700 hover:bg-gray-200 hover:text-gray-900 px-3 py-2 cursor-pointer"
                    (click)="onNavItemClick()"
                  >
                    <app-icon [name]="item.icon" [iconClass]="'size-6'"></app-icon>
                    <span class="ml-3">{{ item.label }}</span>
                  </a>
                </ng-template>
              </ng-template>
            </li>
          </ul>
        </li>
      </ul>
    </nav>

    <div *ngIf="currentMode !== 'slim'" class="border-t border-gray-200/70 px-4 py-3">
      <div class="flex items-center justify-between gap-3">
        <div class="flex items-center gap-3 min-w-0">
          <div class="h-9 w-9 rounded-full bg-indigo-200"></div>
          <div class="min-w-0">
            <div class="text-sm font-medium text-gray-900">Jonathan Navarro</div>
            <div class="text-xs text-gray-500">Ejecutivo</div>
          </div>
        </div>

        <div class="flex items-center">
          <button
            type="button"
            (click)="toggleSidebar()"
            class="inline-flex items-center justify-center h-8 w-8 rounded-md text-gray-500 hover:bg-gray-200 cursor-pointer"
            aria-label="Mostrar/Ocultar sidebar"
          >
            <app-icon name="chevron-double-left" iconClass="size-5"></app-icon>
          </button>
        </div>
      </div>
    </div>

    <div
      *ngIf="currentMode === 'slim'"
      class="flex flex-col items-center gap-2 border-t border-gray-200/70 px-2 py-3"
    >
      <div class="h-9 w-9 rounded-full bg-indigo-200"></div>
      <button
        type="button"
        (click)="toggleSidebar()"
        class="inline-flex items-center justify-center h-8 w-8 rounded-md text-gray-500 hover:bg-gray-200 cursor-pointer"
        aria-label="Ocultar sidebar"
      >
        <app-icon name="chevron-double-right" iconClass="size-5"></app-icon>
      </button>
    </div>
  </div>
</aside>

<div
  *ngIf="currentMode === 'overlay'"
  (click)="closeOverlay()"
  class="fixed inset-0 bg-black/40 z-50"
></div>
