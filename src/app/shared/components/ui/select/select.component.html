<label *ngIf="label" class="text-xs text-gray-600 mb-1 block">{{ label }}</label>

<div class="w-full">
  <ng-container *ngIf="!multiple; else multiTpl">
    <div class="relative" [appCloseOnInteract]="isOpen" (requestClose)="close()">
      <button
        type="button"
        class="w-full rounded border px-3 py-2 pr-8 text-sm border-gray-300 focus:outline-none focus-visible:ring-1 focus-visible:ring-indigo-200 focus:border-indigo-500 appearance-none text-left flex items-center"
        [disabled]="disabled"
        [class.bg-gray-200]="disabled"
        [class.text-gray-400]="disabled"
        [class.border-red-500]="!!error"
        (click)="toggleOpen()"
        [attr.aria-expanded]="isOpen"
        [attr.aria-disabled]="disabled"
        [attr.aria-invalid]="!!error"
      >
        <span
          class="truncate"
          [class.text-gray-400]="disabled || !selectedLabels"
          [class.text-gray-700]="!disabled && !!selectedLabels"
        >
          {{ selectedLabels || placeholder || '\u00A0' }}
        </span>
      </button>

      <div class="absolute inset-y-0 right-2 flex items-center space-x-2">
        <button
          *ngIf="clearable && hasValue && !disabled"
          type="button"
          class="inline-flex items-center justify-center rounded-full p-1 hover:bg-gray-100 cursor-pointer"
          aria-label="Limpiar"
          (click)="clearSelection($event)"
        >
          <app-icon name="close" class="h-4 w-4 text-gray-500"></app-icon>
        </button>
        <div class="pointer-events-none">
          <app-icon name="chevron-down" class="h-4 w-4 text-gray-500"></app-icon>
        </div>
      </div>

      <div
        *ngIf="isOpen"
        class="absolute z-10 mt-1 w-full bg-white border rounded border-gray-300 shadow max-h-60 overflow-auto"
      >
        <div *ngIf="searchable" class="p-2">
          <input
            type="text"
            class="w-full rounded border px-3 py-2 text-sm border-gray-300 focus:outline-none"
            placeholder="Buscar..."
            [value]="filterText"
            (input)="filterText = $any($event.target).value"
          />
        </div>
        <ul class="divide-y divide-gray-300">
          <ng-container *ngFor="let entry of filteredOptions">
            <!-- Si es un grupo, renderizar cabecera + opciones -->
            <li *ngIf="entry && entry.options">
              <div class="px-3 py-2 text-xs font-medium text-gray-600">{{ entry.label }}</div>
              <ul class="divide-y divide-gray-200">
                <li *ngFor="let o of entry.options">
                  <label
                    class="flex items-center w-full px-3 py-2 hover:bg-gray-300 cursor-pointer"
                    role="option"
                    [attr.tabindex]="disabled ? -1 : 0"
                    (click)="disabled ? null : toggleOption(o.value)"
                    (keydown.enter)="disabled ? null : toggleOption(o.value)"
                    (keydown.space)="
                      $event.preventDefault(); disabled ? null : toggleOption(o.value)
                    "
                    [class.pointer-events-none]="disabled"
                    [attr.aria-disabled]="disabled"
                  >
                    <span class="flex-1">{{ o.label }}</span>
                    <app-icon
                      *ngIf="isSelected(o.value)"
                      name="check"
                      class="h-4 w-4 text-gray-500"
                      aria-hidden="true"
                    ></app-icon>
                  </label>
                </li>
              </ul>
            </li>

            <!-- Si es opciÃ³n simple -->
            <li *ngIf="entry && !entry.options">
              <label
                class="flex items-center w-full px-3 py-2 hover:bg-gray-300 cursor-pointer"
                role="option"
                [attr.tabindex]="disabled ? -1 : 0"
                (click)="disabled ? null : toggleOption(entry.value)"
                (keydown.enter)="disabled ? null : toggleOption(entry.value)"
                (keydown.space)="
                  $event.preventDefault(); disabled ? null : toggleOption(entry.value)
                "
                [class.pointer-events-none]="disabled"
                [attr.aria-disabled]="disabled"
              >
                <span class="flex-1">{{ entry.label }}</span>
                <app-icon
                  *ngIf="isSelected(entry.value)"
                  name="check"
                  class="h-4 w-4 text-gray-500"
                  aria-hidden="true"
                ></app-icon>
              </label>
            </li>
          </ng-container>
        </ul>
      </div>
    </div>

    <div *ngIf="error" class="text-xs text-red-600 mt-1">{{ error }}</div>
  </ng-container>

  <ng-template #multiTpl>
    <div class="relative" [appCloseOnInteract]="isOpen" (requestClose)="close()">
      <button
        type="button"
        class="w-full rounded border px-3 py-2 pr-8 text-sm border-gray-300 focus:outline-none focus-visible:ring-1 focus-visible:ring-indigo-200 focus:border-indigo-500 appearance-none text-left flex items-center"
        [disabled]="disabled"
        [class.bg-gray-200]="disabled"
        [class.text-gray-400]="disabled"
        [class.border-red-500]="!!error"
        (click)="toggleOpen()"
        [attr.aria-expanded]="isOpen"
        [attr.aria-disabled]="disabled"
        [attr.aria-invalid]="!!error"
      >
        <span
          class="truncate"
          [class.text-gray-400]="disabled || !selectedLabels"
          [class.text-gray-700]="!disabled && !!selectedLabels"
        >
          {{ selectedLabels || placeholder || '\u00A0' }}
        </span>
      </button>

      <div class="absolute inset-y-0 right-2 flex items-center space-x-2">
        <button
          *ngIf="clearable && hasValue && !disabled"
          type="button"
          class="inline-flex items-center justify-center rounded-full p-1 hover:bg-gray-100 cursor-pointer"
          aria-label="Limpiar"
          (click)="clearSelection($event)"
        >
          <app-icon name="close" class="h-4 w-4 text-gray-500"></app-icon>
        </button>
        <div class="pointer-events-none">
          <app-icon name="chevron-down" class="h-4 w-4 text-gray-500"></app-icon>
        </div>
      </div>

      <div
        *ngIf="isOpen"
        class="absolute z-10 mt-1 w-full bg-white border rounded border-gray-300 max-h-60 overflow-auto"
      >
        <div *ngIf="searchable" class="p-2">
          <input
            type="text"
            class="w-full rounded border px-3 py-2 text-sm border-gray-300 focus:outline-none"
            placeholder="Buscar..."
            [value]="filterText"
            (input)="filterText = $any($event.target).value"
          />
        </div>
        <ul class="divide-y divide-gray-300">
          <ng-container *ngFor="let entry of filteredOptions">
            <li *ngIf="entry && entry.options">
              <div class="px-3 py-2 text-xs font-medium text-gray-600">{{ entry.label }}</div>
              <ul class="divide-y divide-gray-200">
                <li *ngFor="let o of entry.options">
                  <label
                    class="flex items-center px-3 py-2 hover:bg-gray-300 cursor-pointer"
                    [attr.aria-disabled]="disabled"
                  >
                    <input
                      type="checkbox"
                      class="mr-3"
                      [checked]="isSelected(o.value)"
                      (change)="toggleOption(o.value)"
                      [disabled]="disabled"
                    />
                    <span class="flex-1">{{ o.label }}</span>
                  </label>
                </li>
              </ul>
            </li>

            <li *ngIf="entry && !entry.options">
              <label
                class="flex items-center px-3 py-2 hover:bg-gray-300 cursor-pointer"
                [attr.aria-disabled]="disabled"
              >
                <input
                  type="checkbox"
                  class="mr-3"
                  [checked]="isSelected(entry.value)"
                  (change)="toggleOption(entry.value)"
                  [disabled]="disabled"
                />
                <span class="flex-1">{{ entry.label }}</span>
              </label>
            </li>
          </ng-container>
        </ul>
      </div>
    </div>

    <div *ngIf="error" class="text-xs text-red-600 mt-1">{{ error }}</div>
  </ng-template>
</div>
