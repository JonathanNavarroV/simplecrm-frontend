<label *ngIf="label" class="text-xs text-gray-600 mb-1 block">{{ label }}</label>

<div class="w-full">
  <ng-container *ngIf="!multiple; else multiTpl">
    <div
      *ngIf="!isSkeleton"
      class="relative"
      [appCloseOnInteract]="isOpen"
      (requestClose)="close()"
    >
      <button
        #buttonRef
        type="button"
        class="w-full rounded border px-3 py-2 pr-8 text-sm border-gray-300 focus:outline-none focus-visible:ring-1 focus-visible:ring-indigo-200 focus:border-indigo-500 appearance-none text-left flex items-center"
        [class.ring-1]="isOpen"
        [class.ring-indigo-200]="isOpen"
        [class.border-indigo-500]="isOpen"
        [disabled]="disabled || isLoading"
        [attr.aria-busy]="isLoading"
        [class.pointer-events-none]="isLoading"
        [class.bg-gray-200]="disabled || isLoading"
        [class.text-gray-400]="disabled || isLoading"
        [class.border-red-500]="!!error"
        (click)="toggleOpen()"
        [attr.aria-expanded]="isOpen"
        [attr.aria-disabled]="disabled"
        [attr.aria-invalid]="!!error"
      >
        <span
          class="truncate"
          [class.text-gray-400]="disabled || isLoading || !selectedLabels"
          [class.text-gray-700]="!disabled && !!selectedLabels && !isLoading"
        >
          {{ selectedLabels || placeholder || '\u00A0' }}
        </span>
      </button>

      <div class="absolute inset-y-0 right-2 flex items-center space-x-2">
        <button
          *ngIf="clearable && hasValue && !disabled && !isLoading"
          type="button"
          class="inline-flex items-center justify-center rounded-full p-1 hover:bg-gray-100 cursor-pointer"
          aria-label="Limpiar"
          (click)="clearSelection($event)"
        >
          <app-icon name="close" iconClass="h-4 w-4 text-gray-500"></app-icon>
        </button>
        <div class="flex items-center justify-center" (click)="toggleOpen()">
          <ng-container *ngIf="!isLoading; else spinnerTpl">
            <app-icon name="chevron-down" iconClass="h-4 w-4 text-gray-500"></app-icon>
          </ng-container>
          <ng-template #spinnerTpl>
            <span
              class="inline-block w-4 h-4 border-2 border-t-transparent border-gray-500 rounded-full animate-spin bg-transparent"
              aria-hidden="true"
            ></span>
          </ng-template>
        </div>
      </div>

      <div
        *ngIf="isOpen"
        class="absolute z-10 w-full bg-white border rounded border-gray-300 shadow overflow-auto"
        [ngClass]="isOpenUp ? 'bottom-full mb-1' : 'mt-1'"
        [ngStyle]="{ 'max-height': computedMaxHeight }"
      >
        <div *ngIf="searchable" class="p-2">
          <input
            #searchInput
            type="text"
            class="w-full rounded border px-3 py-2 text-sm border-gray-300 focus:outline-none"
            placeholder="Buscar..."
            [value]="filterText"
            (input)="filterText = $any($event.target).value"
          />
        </div>
        <ul class="divide-y divide-gray-300">
          <ng-container *ngFor="let entry of filteredOptions">
            <!-- Si es un grupo, renderizar cabecera + opciones -->
            <li *ngIf="entry && entry.options">
              <div class="px-3 py-2 text-xs font-medium text-gray-600 select-none">
                {{ entry.label }}
              </div>
              <ul class="divide-y divide-gray-200">
                <li *ngFor="let o of entry.options">
                  <label
                    class="flex items-center w-full px-3 py-2 hover:bg-gray-300 cursor-pointer select-none"
                    role="option"
                    [attr.tabindex]="disabled ? -1 : 0"
                    (click)="disabled ? null : toggleOption(o.value)"
                    (keydown.enter)="disabled ? null : toggleOption(o.value)"
                    (keydown.space)="
                      $event.preventDefault(); disabled ? null : toggleOption(o.value)
                    "
                    [class.pointer-events-none]="disabled"
                    [attr.aria-disabled]="disabled"
                  >
                    <span class="flex-1">{{ o.label }}</span>
                    <app-icon
                      *ngIf="isSelected(o.value)"
                      name="check"
                      iconClass="h-4 w-4 text-gray-500"
                      aria-hidden="true"
                    ></app-icon>
                  </label>
                </li>
              </ul>
            </li>

            <!-- Si es opciÃ³n simple -->
            <li *ngIf="entry && !entry.options">
              <label
                class="flex items-center w-full px-3 py-2 hover:bg-gray-300 cursor-pointer select-none"
                role="option"
                [attr.tabindex]="disabled ? -1 : 0"
                (click)="disabled ? null : toggleOption(entry.value)"
                (keydown.enter)="disabled ? null : toggleOption(entry.value)"
                (keydown.space)="
                  $event.preventDefault(); disabled ? null : toggleOption(entry.value)
                "
                [class.pointer-events-none]="disabled"
                [attr.aria-disabled]="disabled"
              >
                <span class="flex-1">{{ entry.label }}</span>
                <app-icon
                  *ngIf="isSelected(entry.value)"
                  name="check"
                  iconClass="h-4 w-4 text-gray-500"
                  aria-hidden="true"
                ></app-icon>
              </label>
            </li>
          </ng-container>
        </ul>
        <ng-container *ngIf="filteredOptions?.length === 0">
          <div class="px-3 py-3 text-sm text-gray-500 select-none">
            No hay elementos para mostrar
          </div>
        </ng-container>
      </div>
    </div>

    <div *ngIf="isSkeleton" class="relative w-full animate-pulse">
      <div
        class="px-3 py-2 h-9.5 rounded border border-gray-300 bg-gradient-to-r from-gray-200 via-gray-100 to-gray-200 bg-[length:200%_100%] animate-shimmer"
      ></div>
    </div>

    <div *ngIf="error" class="text-xs text-red-600 mt-1">{{ error }}</div>
  </ng-container>

  <ng-template #multiTpl>
    <div
      *ngIf="!isSkeleton"
      class="relative"
      [appCloseOnInteract]="isOpen"
      (requestClose)="close()"
    >
      <button
        #buttonRef
        type="button"
        class="w-full rounded border px-3 py-2 pr-8 text-sm border-gray-300 focus:outline-none focus-visible:ring-1 focus-visible:ring-indigo-200 focus:border-indigo-500 appearance-none text-left flex items-center"
        [class.ring-1]="isOpen"
        [class.ring-indigo-200]="isOpen"
        [class.border-indigo-500]="isOpen"
        [disabled]="disabled || isLoading"
        [attr.aria-busy]="isLoading"
        [class.pointer-events-none]="isLoading"
        [class.bg-gray-200]="disabled || isLoading"
        [class.text-gray-400]="disabled || isLoading"
        [class.border-red-500]="!!error"
        (click)="toggleOpen()"
        [attr.aria-expanded]="isOpen"
        [attr.aria-disabled]="disabled"
        [attr.aria-invalid]="!!error"
      >
        <span
          class="truncate"
          [class.text-gray-400]="disabled || isLoading || !selectedLabels"
          [class.text-gray-700]="!disabled && !!selectedLabels && !isLoading"
        >
          {{ selectedLabels || placeholder || '\u00A0' }}
        </span>
      </button>

      <div class="absolute inset-y-0 right-2 flex items-center space-x-2">
        <button
          *ngIf="clearable && hasValue && !disabled && !isLoading"
          type="button"
          class="inline-flex items-center justify-center rounded-full p-1 hover:bg-gray-100 cursor-pointer"
          aria-label="Limpiar"
          (click)="clearSelection($event)"
        >
          <app-icon name="close" iconClass="h-4 w-4 text-gray-500"></app-icon>
        </button>
        <div class="flex items-center justify-center" (click)="toggleOpen()">
          <ng-container *ngIf="!isLoading; else spinnerTpl2">
            <app-icon name="chevron-down" iconClass="h-4 w-4 text-gray-500"></app-icon>
          </ng-container>
          <ng-template #spinnerTpl2>
            <span
              class="inline-block w-4 h-4 border-2 border-t-transparent border-gray-500 rounded-full animate-spin bg-transparent"
              aria-hidden="true"
            ></span>
          </ng-template>
        </div>
      </div>

      <div
        *ngIf="isOpen"
        class="absolute z-10 w-full bg-white border rounded border-gray-300 overflow-auto"
        [ngClass]="isOpenUp ? 'bottom-full mb-1' : 'mt-1'"
        [ngStyle]="{ 'max-height': computedMaxHeight }"
      >
        <div *ngIf="searchable" class="p-2">
          <input
            #searchInput
            type="text"
            class="w-full rounded border px-3 py-2 text-sm border-gray-300 focus:outline-none"
            placeholder="Buscar..."
            [value]="filterText"
            (input)="filterText = $any($event.target).value"
          />
        </div>
        <ul class="divide-y divide-gray-300">
          <ng-container *ngFor="let entry of filteredOptions">
            <li *ngIf="entry && entry.options">
              <div class="px-3 py-2 text-xs font-medium text-gray-600 select-none">
                {{ entry.label }}
              </div>
              <ul class="divide-y divide-gray-200">
                <li *ngFor="let o of entry.options">
                  <label
                    class="flex items-center px-3 py-2 hover:bg-gray-300 cursor-pointer select-none"
                    [attr.aria-disabled]="disabled"
                  >
                    <input
                      type="checkbox"
                      class="mr-3"
                      [checked]="isSelected(o.value)"
                      (change)="toggleOption(o.value)"
                      [disabled]="disabled"
                    />
                    <span class="flex-1">{{ o.label }}</span>
                  </label>
                </li>
              </ul>
            </li>

            <li *ngIf="entry && !entry.options">
              <label
                class="flex items-center px-3 py-2 hover:bg-gray-300 cursor-pointer select-none"
                [attr.aria-disabled]="disabled"
              >
                <input
                  type="checkbox"
                  class="mr-3"
                  [checked]="isSelected(entry.value)"
                  (change)="toggleOption(entry.value)"
                  [disabled]="disabled"
                />
                <span class="flex-1">{{ entry.label }}</span>
              </label>
            </li>
          </ng-container>
        </ul>
        <ng-container *ngIf="filteredOptions?.length === 0">
          <div class="px-3 py-3 text-sm text-gray-500 select-none">
            No hay elementos para mostrar
          </div>
        </ng-container>
      </div>
    </div>

    <div *ngIf="isSkeleton" class="relative w-full animate-pulse">
      <div
        class="px-3 py-2 h-9.5 rounded border border-gray-300 bg-gradient-to-r from-gray-200 via-gray-100 to-gray-200 bg-[length:200%_100%] animate-shimmer"
      ></div>
    </div>

    <div *ngIf="error" class="text-xs text-red-600 mt-1">{{ error }}</div>
  </ng-template>
</div>
